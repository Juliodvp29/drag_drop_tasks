<div class="calendar-container min-h-screen bg-gradient-to-br from-blue-50 via-white to-purple-50 p-4 md:p-6">
  <div class="max-w-7xl mx-auto">

    <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">

        <div class="flex items-center gap-4">
          <div class="flex items-center gap-2">
            <button (click)="previousMonth()" class="p-2 rounded-lg hover:bg-gray-100 transition-colors"
              title="Mes anterior">
              <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
              </svg>
            </button>

            <h1 class="text-2xl md:text-3xl font-bold text-gray-800 min-w-[200px] text-center">
              {{ getMonthYearText() }}
            </h1>

            <button (click)="nextMonth()" class="p-2 rounded-lg hover:bg-gray-100 transition-colors"
              title="Mes siguiente">
              <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
              </svg>
            </button>
          </div>
        </div>

        <div class="flex items-center gap-3 flex-wrap">
          <button (click)="goToToday()"
            class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-dark transition-colors flex items-center gap-2">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd"
                d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z"
                clip-rule="evenodd" />
            </svg>
            Hoy
          </button>

          <button (click)="openCreateModal(selectedDate())"
            class="px-4 py-2 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-lg hover:shadow-lg transition-all flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
            Nuevo Evento
          </button>

          <button (click)="showFilters.set(!showFilters())"
            class="p-2 rounded-lg border-2 border-gray-300 hover:border-primary transition-colors"
            [class.border-primary]="showFilters()" [class.bg-primary]="showFilters()"
            [class.text-white]="showFilters()">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
            </svg>
          </button>
        </div>
      </div>

      @if (showFilters()) {
      <div class="mt-4 pt-4 border-t border-gray-200 animate-slideInUp">
        <div class="flex flex-wrap gap-3">
          <button (click)="toggleEventTypeFilter(EventType.MEETING)"
            class="px-3 py-1 rounded-full text-sm font-medium transition-all"
            [class]="filters().eventTypes.includes(EventType.MEETING) ? 'bg-blue-500 text-white' : 'bg-blue-100 text-blue-700 hover:bg-blue-200'">
            üë• Reuniones
          </button>
          <button (click)="toggleEventTypeFilter(EventType.DEADLINE)"
            class="px-3 py-1 rounded-full text-sm font-medium transition-all"
            [class]="filters().eventTypes.includes(EventType.DEADLINE) ? 'bg-red-500 text-white' : 'bg-red-100 text-red-700 hover:bg-red-200'">
            ‚è∞ Fechas l√≠mite
          </button>
          <button (click)="toggleEventTypeFilter(EventType.HOLIDAY)"
            class="px-3 py-1 rounded-full text-sm font-medium transition-all"
            [class]="filters().eventTypes.includes(EventType.HOLIDAY) ? 'bg-green-500 text-white' : 'bg-green-100 text-green-700 hover:bg-green-200'">
            üéâ Festivos
          </button>
          <button (click)="toggleEventTypeFilter(EventType.REMINDER)"
            class="px-3 py-1 rounded-full text-sm font-medium transition-all"
            [class]="filters().eventTypes.includes(EventType.REMINDER) ? 'bg-yellow-500 text-white' : 'bg-yellow-100 text-yellow-700 hover:bg-yellow-200'">
            üîî Recordatorios
          </button>
        </div>
      </div>
      }

      <div class="mt-4 pt-4 border-t border-gray-200 grid grid-cols-2 md:grid-cols-4 gap-4">
        <div class="text-center">
          <p class="text-2xl font-bold text-primary">{{ getTotalEventsCount() }}</p>
          <p class="text-sm text-gray-600">Total eventos</p>
        </div>
        <div class="text-center">
          <p class="text-2xl font-bold text-green-600">{{ getUpcomingEventsCount() }}</p>
          <p class="text-sm text-gray-600">Pr√≥ximos</p>
        </div>
        <div class="text-center">
          <p class="text-2xl font-bold text-blue-600">{{ selectedDayEvents().length }}</p>
          <p class="text-sm text-gray-600">Hoy seleccionado</p>
        </div>
        <div class="text-center">
          <p class="text-2xl font-bold text-purple-600">{{ getGlobalEventsCount() }}</p>
          <p class="text-sm text-gray-600">Globales</p>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-2xl shadow-lg overflow-hidden">

      <div class="grid grid-cols-7 bg-gradient-to-r from-primary to-secondary text-black">
        @for (day of getWeekDayNames(); track day) {
        <div class="p-4 text-center font-semibold uppercase text-sm">
          {{ day }}
        </div>
        }
      </div>

      <div class="grid grid-cols-7 divide-x divide-y divide-gray-200">
        @for (week of calendarMonth().weeks; track $index) {
        @for (day of week; track day.date) {
        <div (click)="onDayClick(day)"
          class="min-h-[120px] md:min-h-[140px] p-2 cursor-pointer transition-all hover:bg-blue-50 relative group"
          [class.bg-gray-50]="!day.isCurrentMonth" [class.bg-blue-100]="isDaySelected(day) && day.isCurrentMonth"
          [class.bg-yellow-50]="day.isToday && !isDaySelected(day)" [class.border-2]="day.isToday"
          [class.border-yellow-400]="day.isToday">
          <div class="flex items-center justify-between mb-2">
            <span class="text-sm font-semibold rounded-full w-8 h-8 flex items-center justify-center"
              [class.text-gray-400]="!day.isCurrentMonth" [class.text-gray-900]="day.isCurrentMonth && !day.isToday"
              [class.bg-yellow-400]="day.isToday" [class.text-white]="day.isToday" [class.font-bold]="day.isToday">
              {{ day.day }}
            </span>

            @if (getEventsByDay(day).length > 0) {
            <span
              class="text-xs bg-primary text-white rounded-full w-5 h-5 flex items-center justify-center font-medium">
              {{ getEventsByDay(day).length }}
            </span>
            }
          </div>

          <div class="space-y-1 overflow-y-auto max-h-[80px] md:max-h-[100px] overflow-hidden">
            @for (event of getEventsByDay(day).slice(0, 3); track event.id) {
            <div (click)="onEventClick(event, $event)"
              class="text-xs px-2 py-1 rounded truncate cursor-pointer transition-all hover:shadow-md"
              [class]="utils.getEventTypeBgColor(event.event_type) + ' ' + utils.getEventTypeBorderColor(event.event_type)"
              [title]="event.title" style="border-left: 3px solid currentColor;">
              <span [class]="utils.getEventTypeTextColor(event.event_type)">
                {{ utils.getEventTypeIcon(event.event_type) }} {{ event.title }}
              </span>
            </div>
            }

            @if (getEventsByDay(day).length > 3) {
            <div class="text-xs text-gray-500 text-center py-1">
              +{{ getEventsByDay(day).length - 3 }} m√°s
            </div>
            }
          </div>

          <button (click)="openCreateModal(day.date); $event.stopPropagation()"
            class="absolute bottom-2 right-2 w-6 h-6 bg-primary text-white rounded-full opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center hover:bg-primary-dark"
            title="Agregar evento">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
          </button>
        </div>
        }
        }
      </div>
    </div>

    @if (selectedDayEvents().length > 0) {
    <div class="mt-6 bg-white rounded-2xl shadow-lg p-6">
      <h2 class="text-xl font-bold text-gray-800 mb-4">
        Eventos del {{ utils.formatDate(selectedDate(), 'long') }}
      </h2>
      <div class="space-y-3">
        @for (event of selectedDayEvents(); track event.id) {
        <div (click)="onEventClick(event, $event)"
          class="p-4 rounded-lg border-l-4 cursor-pointer transition-all hover:shadow-md"
          [class]="utils.getEventTypeBgColor(event.event_type) + ' ' + utils.getEventTypeBorderColor(event.event_type)">
          <div class="flex items-start justify-between">
            <div class="flex-1">
              <div class="flex items-center gap-2 mb-1">
                <span class="text-2xl">{{ utils.getEventTypeIcon(event.event_type) }}</span>
                <h3 class="font-semibold text-gray-800">{{ event.title }}</h3>
              </div>
              @if (event.description) {
              <p class="text-sm text-gray-600 mb-2">{{ event.description }}</p>
              }
              <div class="flex items-center gap-4 text-xs text-gray-500">
                <span class="flex items-center gap-1">
                  <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd"
                      d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z"
                      clip-rule="evenodd" />
                  </svg>
                  {{ utils.formatTime(event.event_date) }}
                </span>
                <span class="px-2 py-1 rounded-full" [class]="utils.getEventTypeBgColor(event.event_type)">
                  {{ utils.getEventTypeLabel(event.event_type) }}
                </span>
                @if (event.is_global) {
                <span class="px-2 py-1 bg-purple-100 text-purple-700 rounded-full">
                  üåê Global
                </span>
                }
              </div>
            </div>
          </div>
        </div>
        }
      </div>
    </div>
    }
  </div>
</div>

@if (showEventModal() && selectedEvent()) {
<div class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 animate-fadeIn"
  (click)="closeEventModal()">
  <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto"
    (click)="$event.stopPropagation()">
    <div class="p-6">
      <div class="flex items-start justify-between mb-6">
        <div class="flex items-center gap-3">
          <span class="text-4xl">{{ utils.getEventTypeIcon(selectedEvent()!.event_type) }}</span>
          <div>
            <h2 class="text-2xl font-bold text-gray-800">{{ selectedEvent()!.title }}</h2>
            <p class="text-sm text-gray-500">{{ getSelectedEventFormattedDateTime() }}</p>
          </div>
        </div>
        <button (click)="closeEventModal()" class="p-2 rounded-lg hover:bg-gray-100 transition-colors">
          <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>

      <div class="space-y-4">
        @if (selectedEvent()!.description) {
        <div>
          <h3 class="text-sm font-semibold text-gray-700 mb-2">Descripci√≥n</h3>
          <p class="text-gray-600">{{ selectedEvent()!.description }}</p>
        </div>
        }

        <div class="grid grid-cols-2 gap-4">
          <div>
            <h3 class="text-sm font-semibold text-gray-700 mb-2">Tipo</h3>
            <span class="inline-block px-3 py-1 rounded-full text-sm"
              [class]="utils.getEventTypeBgColor(selectedEvent()!.event_type) + ' ' + utils.getEventTypeTextColor(selectedEvent()!.event_type)">
              {{ utils.getEventTypeLabel(selectedEvent()!.event_type) }}
            </span>
          </div>

          <div>
            <h3 class="text-sm font-semibold text-gray-700 mb-2">Alcance</h3>
            <span class="inline-block px-3 py-1 rounded-full text-sm"
              [class]="selectedEvent()!.is_global ? 'bg-purple-100 text-purple-700' : 'bg-gray-100 text-gray-700'">
              {{ selectedEvent()!.is_global ? 'üåê Global' : 'üë§ Personal' }}
            </span>
          </div>
        </div>

        @if (selectedEvent()!.is_recurring) {
        <div>
          <h3 class="text-sm font-semibold text-gray-700 mb-2">Evento Recurrente</h3>
          <p class="text-sm text-gray-600">üîÅ Se repite seg√∫n la regla configurada</p>
        </div>
        }
      </div>

      <div class="mt-6 flex gap-3">
        <button (click)="deleteEvent(selectedEvent()!.id, selectedEvent()!.title)"
          class="flex-1 px-4 py-2 bg-error text-white rounded-lg hover:bg-red-600 transition-colors">
          Eliminar
        </button>
        <button (click)="closeEventModal()"
          class="flex-1 px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">
          Cerrar
        </button>
      </div>
    </div>
  </div>
</div>
}

@if (showCreateModal()) {
<div class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 animate-fadeIn"
  (click)="closeCreateModal()">
  <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto"
    (click)="$event.stopPropagation()">
    <div class="p-6">
      <h2 class="text-2xl font-bold text-gray-800 mb-6">Crear Nuevo Evento</h2>

      <form (submit)="$event.preventDefault(); createEvent()" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">T√≠tulo *</label>
          <input type="text" [(ngModel)]="newEvent().title" name="title" required
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
            placeholder="Nombre del evento" />
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Descripci√≥n</label>
          <textarea [(ngModel)]="newEvent().description" name="description" rows="3"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
            placeholder="Detalles del evento"></textarea>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Fecha *</label>
            <input type="date" [(ngModel)]="newEvent().event_date" name="event_date" required
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary" />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Hora</label>
            <input type="time" [(ngModel)]="newEvent().event_time" name="event_time" [disabled]="newEvent().is_all_day"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary disabled:bg-gray-100" />
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de evento *</label>
          <select [(ngModel)]="newEvent().event_type" name="event_type"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary">
            <option [value]="EventType.MEETING">üë• Reuni√≥n</option>
            <option [value]="EventType.DEADLINE">‚è∞ Fecha l√≠mite</option>
            <option [value]="EventType.HOLIDAY">üéâ Festivo</option>
            <option [value]="EventType.REMINDER">üîî Recordatorio</option>
            <option [value]="EventType.OTHER">üìå Otro</option>
          </select>
        </div>

        <div class="flex items-center gap-2">
          <input type="checkbox" [(ngModel)]="newEvent().is_all_day" name="is_all_day" id="is_all_day"
            class="w-4 h-4 text-primary border-gray-300 rounded focus:ring-primary" />
          <label for="is_all_day" class="text-sm text-gray-700">Evento de todo el d√≠a</label>
        </div>

        <div class="flex gap-3 pt-4">
          <button type="submit"
            class="flex-1 px-4 py-2 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-lg hover:shadow-lg transition-all">
            Crear Evento
          </button>
          <button type="button" (click)="closeCreateModal()"
            class="flex-1 px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">
            Cancelar
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
}

@if (isLoading()) {
<div class="fixed inset-0 bg-black bg-opacity-30 z-40 flex items-center justify-center">
  <div class="bg-white rounded-2xl p-6 shadow-2xl">
    <div class="flex items-center gap-3">
      <svg class="animate-spin h-8 w-8 text-primary" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor"
          d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
        </path>
      </svg>
      <span class="text-lg font-medium text-gray-700">Cargando eventos...</span>
    </div>
  </div>
</div>
}