<div class="bg-white rounded-xl shadow-lg overflow-hidden border-t-4" [style.borderColor]="list.color || '#3b82f6'"
  (dragover)="onDragOver($event)" (drop)="onDrop($event)">

  <div class="p-4 border-b border-gray-100">
    <div class="flex items-center justify-between mb-2">
      <h3 class="text-lg font-semibold text-gray-800">{{ list.name }}</h3>
      <div class="flex items-center gap-2">
        <div class="flex items-center gap-2">
          @if (priorityStats().urgent > 0) {
          <span class="text-xs px-2 py-1 bg-error bg-opacity-20 text-red-700 rounded-full">
            🔴 {{ priorityStats().urgent }}
          </span>
          }
          @if (priorityStats().high > 0) {
          <span class="text-xs px-2 py-1 bg-warning bg-opacity-20 text-yellow-700 rounded-full">
            🟠 {{ priorityStats().high }}
          </span>
          }
        </div>
        <button (click)="toggleOptions()" class="text-gray-400 hover:text-gray-600 p-1 rounded">
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
            <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z">
            </path>
          </svg>
        </button>
      </div>
    </div>

    @if (list.description) {
    <p class="text-sm text-gray-600 mb-2">{{ list.description }}</p>
    }

    <div class="flex items-center justify-between text-sm text-gray-500">
      <span>{{ (list.tasks || []).length }} tareas</span>
      <span>{{ formatDate(list.created_at) }}</span>
    </div>

    @if (showOptions()) {
    <div class="mt-3 pt-3 border-t border-gray-100">
      <button (click)="deleteList()"
        class="text-error text-sm hover:bg-error hover:bg-opacity-10 px-2 py-1 rounded transition-colors">
        Eliminar Lista
      </button>
    </div>
    }
  </div>

  <div class="p-4 border-b border-gray-100">
    <div class="space-y-2">
      <input type="text" placeholder="Agregar nueva tarea..." [(ngModel)]="newTaskTitle"
        (keyup.enter)="!showDescriptionInput() && createTask()"
        class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" />

      @if (!showDescriptionInput() && newTaskTitle().trim()) {
      <button (click)="toggleDescriptionInput()" class="text-xs text-gray-500 hover:text-gray-700">
        + Agregar descripción
      </button>
      }

      @if (showDescriptionInput()) {
      <textarea placeholder="Descripción (opcional)..." [(ngModel)]="newTaskDescription" rows="2"
        class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
      </textarea>
      }

      @if (canAssignTasks() && !showAssignmentInput() && newTaskTitle().trim()) {
      <button (click)="toggleAssignmentInput()" class="text-xs text-gray-500 hover:text-gray-700">
        + Asignar a usuario
      </button>
      }

      @if (showAssignmentInput() && canAssignTasks()) {
      <div class="space-y-2 relative">
        @if (loadingUsers()) {
        <div class="text-xs text-gray-500">Cargando usuarios...</div>
        } @else {
        <input type="text" placeholder="Buscar usuario..." [(ngModel)]="userSearchQuery" (input)="filterUsers()"
          (focus)="showUserDropdown = true" (blur)="hideDropdown()"
          class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" />

        @if (showUserDropdown && filteredUsers().length > 0) {
        <div
          class="absolute z-10 w-full bg-white border border-gray-300 rounded-lg shadow-lg max-h-40 overflow-y-auto mt-1">
          @for (user of filteredUsers(); track user.id) {
          <div (mousedown)="selectUser(user.id)" class="px-3 py-2 hover:bg-gray-100 cursor-pointer text-sm">
            {{ user.first_name }} {{ user.last_name }} <span class="text-gray-500">({{ user.email }})</span>
          </div>
          }
        </div>
        }

        @if (selectedAssignedUser()) {
        <div class="flex items-center justify-between bg-blue-50 px-3 py-2 rounded-lg">
          <span class="text-sm text-blue-700">
            @if (getSelectedUserName()) {
            {{ getSelectedUserName() }}
            }
          </span>
          <button (click)="clearUserSelection()" class="text-blue-500 hover:text-blue-700">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd"
                d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                clip-rule="evenodd"></path>
            </svg>
          </button>
        </div>
        }
        }
      </div>
      }

      <div class="flex gap-2">
        <select [(ngModel)]="selectedTaskPriority" aria-placeholder="prioridad"
          class="flex-1 px-3 py-1 w-11/12 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
          <option value="low">🟢 Baja</option>
          <option value="medium">🟡 Media</option>
          <option value="high">🟠 Alta</option>
          <option value="urgent">🔴 Urgente</option>
        </select>
        <button (click)="createTask()" [disabled]="!newTaskTitle().trim()"
          class="px-3 py-1 bg-primary text-white text-sm rounded-lg hover:bg-primary-dark disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors">
          Agregar
        </button>
      </div>
    </div>
  </div>

  <div class="max-h-96 overflow-y-auto">
    @if ((list.tasks || []).length === 0) {
    <div class="p-8 text-center text-gray-400">
      <div class="text-3xl mb-2">📝</div>
      <p class="text-sm">No hay tareas aquí</p>
      <p class="text-xs">Agrega una tarea o arrastra una existente</p>
    </div>
    } @else {
    <div class="p-2 space-y-2">
      @for (task of sortedTasks(); track task.id) {
      <app-card [task]="task" (taskMoved)="onTaskMoved($event)" (taskDeleted)="onTaskDeleted($event)"
        (taskCompleted)="onTaskCompleted($event)" (taskDetailOpened)="onTaskDetailOpened($event)" />
      }
    </div>
    }
  </div>
</div>