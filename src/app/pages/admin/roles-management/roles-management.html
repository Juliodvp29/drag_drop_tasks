<div class="min-h-screen bg-gray-50 dark:bg-gray-900 p-6">
  <div class="max-w-7xl mx-auto">
    <!-- Header -->
    <div class="mb-8">
      <h1 class="text-4xl font-bold text-gray-800 dark:text-gray-100 mb-4">Gesti√≥n de Roles</h1>
      <p class="text-gray-600 dark:text-gray-400">Administra roles y permisos del sistema</p>
    </div>

    <!-- Controls -->
    <div class="bg-white dark:bg-gray-800 rounded-lg p-6 shadow-md mb-6">
      <div class="flex flex-wrap gap-4 items-center justify-between">
        <div class="flex gap-4 items-center">
          <label class="flex items-center gap-2">
            <input type="checkbox" [checked]="showInactive()" (change)="toggleShowInactive()"
              class="rounded border-gray-300 text-primary focus:ring-primary">
            <span class="text-sm text-gray-700 dark:text-gray-300">Mostrar roles inactivos</span>
          </label>
        </div>

        <button (click)="openCreateModal()" [disabled]="loading()"
          class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-dark disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors">
          <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
          </svg>
          Crear Rol
        </button>
      </div>
    </div>

    <!-- Loading -->
    @if (loading()) {
    <div class="flex justify-center items-center py-12">
      <div class="text-center">
        <div class="inline-block animate-spin text-4xl mb-2">‚è≥</div>
        <p class="text-gray-600 dark:text-gray-400">Cargando...</p>
      </div>
    </div>
    }

    <!-- Roles Table -->
    @if (!loading()) {
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden">
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
          <thead class="bg-gray-50 dark:bg-gray-700">
            <tr>
              <th
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                Rol
              </th>
              <th
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                Descripci√≥n
              </th>
              <th
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                Permisos
              </th>
              <th
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                Estado
              </th>
              <th
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                Tipo
              </th>
              <th
                class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                Acciones
              </th>
            </tr>
          </thead>
          <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
            @for (role of roles(); track role.id) {
            <tr [class.bg-gray-50]="!role.is_active" [class.dark:bg-gray-700]="!role.is_active"
              [class.opacity-75]="!role.is_active">
              <td class="px-6 py-4 whitespace-nowrap">
                <div>
                  <div class="text-sm font-medium text-gray-900 dark:text-gray-100">{{ role.display_name }}</div>
                  <div class="text-sm text-gray-500 dark:text-gray-400">{{ role.name }}</div>
                </div>
              </td>
              <td class="px-6 py-4">
                <div class="text-sm text-gray-900 dark:text-gray-100 max-w-xs truncate" [title]="role.description">
                  {{ role.description || '-' }}
                </div>
              </td>
              <td class="px-6 py-4">
                <div class="flex flex-wrap gap-1">
                  @for (permission of role.permissions.slice(0, 2); track permission) {
                  <span
                    class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200">
                    {{ permission }}
                  </span>
                  }
                  @if (role.permissions.length > 2) {
                  <span
                    class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200">
                    +{{ role.permissions.length - 2 }}
                  </span>
                  }
                  @if (role.permissions.length === 0) {
                  <span class="text-sm text-gray-500 dark:text-gray-400">-</span>
                  }
                </div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
                  [class.bg-green-100]="role.is_active" [class.dark:bg-green-900]="role.is_active"
                  [class.text-green-800]="role.is_active" [class.dark:text-green-200]="role.is_active"
                  [class.bg-red-100]="!role.is_active" [class.dark:bg-red-900]="!role.is_active"
                  [class.text-red-800]="!role.is_active" [class.dark:text-red-200]="!role.is_active">
                  {{ role.is_active ? 'Activo' : 'Inactivo' }}
                </span>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                @if (role.is_system_role) {
                <span
                  class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 dark:bg-purple-900 text-purple-800 dark:text-purple-200">
                  Sistema
                </span>
                } @else {
                <span
                  class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200">
                  Personalizado
                </span>
                }
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                <div class="flex justify-end gap-2">
                  <button (click)="openEditModal(role)"
                    class="text-blue-600 dark:text-blue-400 hover:text-blue-900 dark:hover:text-blue-300 p-1 rounded"
                    title="Editar rol">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z">
                      </path>
                    </svg>
                  </button>

                  @if (!role.is_system_role) {
                  <button (click)="toggleRoleStatus(role)" [class.text-green-600]="!role.is_active"
                    [class.dark:text-green-400]="!role.is_active" [class.text-red-600]="role.is_active"
                    [class.dark:text-red-400]="role.is_active" [class.hover:text-green-900]="!role.is_active"
                    [class.dark:hover:text-green-300]="!role.is_active" [class.hover:text-red-900]="role.is_active"
                    [class.dark:hover:text-red-300]="role.is_active" class="p-1 rounded"
                    [title]="role.is_active ? 'Desactivar rol' : 'Activar rol'">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        [attr.d]="role.is_active ? 'M13 10V3L4 14h7v7l9-11h-7z' : 'M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z'">
                      </path>
                    </svg>
                  </button>

                  <button (click)="deleteRole(role)"
                    class="text-red-600 dark:text-red-400 hover:text-red-900 dark:hover:text-red-300 p-1 rounded"
                    title="Eliminar rol">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                      </path>
                    </svg>
                  </button>
                  }
                </div>
              </td>
            </tr>
            }
          </tbody>
        </table>
      </div>
    </div>
    }

    <!-- Empty State -->
    @if (!loading() && roles().length === 0) {
    <div class="text-center py-12">
      <div class="text-gray-400 dark:text-gray-500 text-6xl mb-4">üë•</div>
      <h3 class="text-xl font-semibold text-gray-600 dark:text-gray-400 mb-2">No hay roles</h3>
      <p class="text-gray-500 dark:text-gray-400">Crea tu primer rol para comenzar</p>
    </div>
    }
  </div>

  <!-- Create Role Modal -->
  @if (showCreateModal()) {
  <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white dark:bg-gray-800 rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
      <div class="p-6">
        <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-6">Crear Nuevo Rol</h2>

        <form (ngSubmit)="createRole()" class="space-y-6">
          <!-- Basic Info -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Nombre del Rol *</label>
              <input type="text" [(ngModel)]="newRole().name" name="name" required
                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Nombre para Mostrar
                *</label>
              <input type="text" [(ngModel)]="newRole().display_name" name="displayName" required
                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Descripci√≥n</label>
            <textarea [(ngModel)]="newRole().description" name="description" rows="3"
              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"></textarea>
          </div>
          <!-- Permissions -->
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-4">Permisos</label>
            @for (categoryGroup of getPermissionsByCategory(); track categoryGroup.category) {
            <div class="mb-4">
              <h4 class="text-sm font-medium text-gray-800 dark:text-gray-200 mb-2 capitalize">{{ categoryGroup.category
                }}</h4>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                @for (permission of categoryGroup.permissions; track permission.id) {
                <label class="flex items-center gap-2">
                  <input type="checkbox" [checked]="hasPermission(newRole(), permission.name)"
                    (change)="togglePermission(newRole(), permission.name)"
                    class="rounded border-gray-300 dark:border-gray-600 text-primary focus:ring-primary">
                  <span class="text-sm text-gray-700 dark:text-gray-300">{{ permission.display_name }}</span>
                </label>
                }
              </div>
            </div>
            }
          </div>

          <!-- Actions -->
          <div class="flex gap-3 pt-4 border-t">
            <button type="button" (click)="closeCreateModal()"
              class="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
              Cancelar
            </button>
            <button type="submit" [disabled]="loading() || !newRole().name.trim() || !newRole().display_name.trim()"
              class="flex-1 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-dark disabled:bg-gray-300 dark:disabled:bg-gray-600 disabled:cursor-not-allowed transition-colors">
              @if (loading()) {
              <span class="inline-block animate-spin mr-2">‚è≥</span>
              }
              Crear Rol
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
  }

  <!-- Edit Role Modal -->
  @if (editingRole()) {
  <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white dark:bg-gray-800 rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
      <div class="p-6">
        <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-6">Editar Rol</h2>

        <form (ngSubmit)="updateRole()" class="space-y-6">
          <!-- Basic Info -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Nombre del Rol</label>
              <input type="text" [value]="editingRole()!.name" disabled
                class="w-full px-3 py-2 border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-700 text-gray-500 dark:text-gray-400 rounded-lg cursor-not-allowed">
              <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">El nombre del rol no se puede cambiar</p>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Nombre para Mostrar
                *</label>
              <input type="text" [(ngModel)]="editRole().display_name" name="editDisplayName" required
                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Descripci√≥n</label>
            <textarea [(ngModel)]="editRole().description" name="editDescription" rows="3"
              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"></textarea>
          </div>
          <!-- Permissions -->
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-4">Permisos</label>
            @for (categoryGroup of getPermissionsByCategory(); track categoryGroup.category) {
            <div class="mb-4">
              <h4 class="text-sm font-medium text-gray-800 dark:text-gray-200 mb-2 capitalize">{{ categoryGroup.category
                }}</h4>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                @for (permission of categoryGroup.permissions; track permission.id) {
                <label class="flex items-center gap-2">
                  <input type="checkbox" [checked]="hasPermission(editRole(), permission.name)"
                    (change)="togglePermission(editRole(), permission.name)"
                    class="rounded border-gray-300 dark:border-gray-600 text-primary focus:ring-primary">
                  <span class="text-sm text-gray-700 dark:text-gray-300">{{ permission.display_name }}</span>
                </label>
                }
              </div>
            </div>
            }
          </div>

          <!-- Actions -->
          <div class="flex gap-3 pt-4 border-t">
            <button type="button" (click)="closeEditModal()"
              class="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
              Cancelar
            </button>
            <button type="submit" [disabled]="loading() || !editRole().display_name?.trim()"
              class="flex-1 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-dark disabled:bg-gray-300 dark:disabled:bg-gray-600 disabled:cursor-not-allowed transition-colors">
              @if (loading()) {
              <span class="inline-block animate-spin mr-2">‚è≥</span>
              }
              Actualizar Rol
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
  }
</div>