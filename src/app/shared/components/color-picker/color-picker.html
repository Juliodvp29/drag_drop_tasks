<div class="color-picker-container relative">
  <!-- Label opcional -->
  @if (label) {
  <label class="block text-sm font-medium text-gray-700 mb-2">
    {{ label }}
  </label>
  }

  <!-- Botón trigger -->
  <button type="button" (click)="toggleDropdown()"
    class="w-full flex items-center justify-between px-4 py-2 bg-white border border-gray-300 rounded-lg hover:border-gray-400 focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary transition-all duration-200"
    [class.ring-2]="isOpen()" [class.ring-primary]="isOpen()" [class.border-primary]="isOpen()">
    <div class="flex items-center gap-3">
      <!-- Color preview -->
      <div class="w-6 h-6 rounded-md border border-gray-300 shadow-sm flex items-center justify-center flex-shrink-0"
        [class]="selectedColor() ? getColorClass(selectedColor()!) : 'bg-gray-100'">
        @if (!selectedColor()) {
        <svg class="w-3 h-3 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
          <path
            d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z">
          </path>
        </svg>
        }
      </div>

      <!-- Text -->
      <div class="text-left">
        <div class="text-sm text-gray-900">
          {{ selectedColor() ? getColorName(selectedColor()!) : placeholder }}
        </div>
      </div>
    </div>

    <!-- Arrow -->
    <svg class="w-4 h-4 text-gray-500 transition-transform duration-200" [class.rotate-180]="isOpen()"
      fill="currentColor" viewBox="0 0 20 20">
      <path fill-rule="evenodd"
        d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
        clip-rule="evenodd"></path>
    </svg>
  </button>

  <!-- Dropdown Modal -->
  @if (isOpen()) {
  <div class="absolute top-full left-0 right-0 mt-2 z-50 animate-in slide-in-from-top-2 duration-200">
    <div class="bg-white rounded-lg shadow-lg border border-gray-200 p-5 w-64">
      <!-- Header -->
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-sm font-medium text-gray-900">Selecciona un color</h3>
        <button type="button" (click)="closeDropdown()" class="text-gray-400 hover:text-gray-600 transition-colors">
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd"
              d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
              clip-rule="evenodd"></path>
          </svg>
        </button>
      </div>

      <!-- Color seleccionado actual -->
      @if (selectedColor()) {
      <div class="flex items-center gap-2 mb-4 p-2 bg-gray-50 rounded-lg">
        <div class="w-5 h-5 rounded border border-gray-300" [class]="getColorClass(selectedColor()!)"></div>
        <div class="text-sm text-gray-700">
          {{ getColorName(selectedColor()!) }}
        </div>
      </div>
      }

      <!-- Grid de colores -->
      <div class="grid grid-cols-5 gap-x-4 gap-y-3 mb-4">
        <!-- Opción "Sin color" -->
        @if (allowEmpty) {
        <button type="button" (click)="selectColor(null)"
          class="w-8 h-8 rounded-lg border-2 transition-all duration-200 flex items-center justify-center hover:scale-105 hover:shadow-sm"
          [class]="!selectedColor() ? 'border-primary bg-gray-100 ring-1 ring-primary' : 'border-gray-300 bg-gray-50 hover:border-gray-400'"
          title="Sin color">
          <svg class="w-3 h-3 text-gray-500" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path>
          </svg>
        </button>
        }

        <!-- Colores disponibles -->
        @for (color of colorOptions; track color.value) {
        <button type="button" (click)="selectColor(color.value)"
          class="w-8 h-8 rounded-lg border-2 transition-all duration-200 hover:scale-105 shadow-sm relative group"
          [class]="color.class" [class.ring-2]="selectedColor() === color.value"
          [class.ring-primary]="selectedColor() === color.value" [class.ring-offset-1]="selectedColor() === color.value"
          [class.border-gray-300]="selectedColor() !== color.value"
          [class.border-primary]="selectedColor() === color.value"
          [title]="color.name + (color.description ? ' - ' + color.description : '')">
          <!-- Checkmark para color seleccionado -->
          @if (selectedColor() === color.value) {
          <svg class="w-3 h-3 text-white drop-shadow-sm" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd"
              d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
              clip-rule="evenodd"></path>
          </svg>
          }
        </button>
        }
      </div>

      <!-- Input de color personalizado (opcional) -->
      @if (allowCustomColor) {
      <div class="pt-4 border-t border-gray-200">
        <label class="block text-xs font-medium text-gray-600 mb-2">Color personalizado</label>
        <div class="flex items-center gap-2">
          <input type="color" [value]="customColorInput()" (input)="onCustomColorChange($event)"
            class="w-6 h-6 rounded border border-gray-300 cursor-pointer" />
          <input type="text" [value]="customColorInput()" (input)="onCustomColorInputChange($event)"
            placeholder="#000000"
            class="flex-1 px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-primary" />
          <button type="button" (click)="applyCustomColor()" [disabled]="!isValidHexColor(customColorInput())"
            class="px-2 py-1 text-xs bg-primary text-white rounded hover:bg-primary-dark disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors">
            ✓
          </button>
        </div>
      </div>
      }
    </div>
  </div>
  }
</div>

<!-- Overlay para cerrar al hacer click afuera -->
@if (isOpen()) {
<div class="fixed inset-0 z-40" (click)="closeDropdown()"></div>
}